# App Router server import guard (narrowed scope)
# Covers app/* files not handled by ESLint rules:
# - @corso/no-server-in-client: covers client components ('use client')
# - @corso/no-server-in-edge: covers Edge runtime files (runtime: 'edge')
# - @corso/forbid-security-barrel-in-client-or-edge: covers @/lib/security barrel
# This rule covers remaining app/* files (Node runtime, no 'use client')
id: ban-server-imports-in-app
language: ts
rule:
  all:
    - regex:
        kind: file
        regex: "^app/.+/page\\.(ts|tsx)$|^app/.+/layout\\.(ts|tsx)$|^app/.+/route\\.(ts|tsx)$"
    - not:
        any:
          # Exclude client components (handled by ESLint @corso/no-server-in-client)
          - has:
              pattern: "'use client'"
          # Exclude Edge runtime files (handled by ESLint @corso/no-server-in-edge)
          - has:
              pattern: "export const runtime = 'edge'"
          - has:
              pattern: 'export const runtime = "edge"'
    - pattern: |
        import $S from '$PATH';
  constraints:
    any:
      - byRegex: PATH
        regex: ^@/lib/server(/.*)?$
      - byRegex: PATH
        regex: ^server-only$
      - byRegex: PATH
        regex: ^fs$
      - byRegex: PATH
        regex: ^os$
      - byRegex: PATH
        regex: ^crypto$
message: "Server-only import used in app/* route/layout. Use Node runtime file or move to server domain."
severity: error

