---
rule_id: warehouse-query-hooks
title: Warehouse Query Hooks & Best Practices
owners:
  - platform@corso.io
last_reviewed: "2025-10-13"
status: active
domains: [analytics, hooks, api]
enforcement: warn
related_rules:
  - security-standards
  - runtime-boundaries
  - code-quality-standards
alwaysApply: true
globs: ["hooks/**", "app/**", "components/**"]
summary: Secure, performant React hooks for ClickHouse queries with React Query integration and type safety.
---

# Warehouse Query Hooks & Best Practices

**Secure, performant React hooks for ClickHouse data warehouse queries with React Query integration.**

## TL;DR
- **Use domain hooks**: `useWarehouseQuery` for simple queries, `useWarehouseQueryCached` for complex caching
- **Never direct SQL construction**: Always use parameterized queries
- **Handle states**: Always manage loading, error, and empty data states
- **Type safety**: Always specify generic types for query results
- **Performance**: Use appropriate `staleTime` and cache keys

## Purpose
Provide secure, performant React hooks for ClickHouse data warehouse queries with React Query integration, type safety, and proper error handling.

## Core Hook Patterns

### ✅ CORRECT: Domain Hook Usage

```typescript
// Simple queries with automatic cache keys
import { useWarehouseQuery } from '@/hooks/dashboard';

const { data, isLoading, error } = useWarehouseQuery<ProjectRow>(
  'SELECT * FROM projects'
);

// Complex queries with custom cache keys
import { useWarehouseQueryCached } from '@/hooks/dashboard';

const { data, isLoading, error } = useWarehouseQueryCached<ProjectRow>(
  ['projects', filters],
  'SELECT * FROM projects WHERE status = ?',
  { staleTime: 5 * 60 * 1000 }
);
```

### ❌ INCORRECT: Direct SQL Construction

```typescript
// NEVER do this - SQL injection vulnerability
const sql = `SELECT * FROM projects WHERE status = '${status}'`;
const { data } = useWarehouseQuery(sql);
```

## Security & SQL Injection Prevention

### SQL Injection Prevention
- ✅ **MUST** use parameterized queries (server-side)
- ❌ **NEVER** use string interpolation in SQL

## Performance Optimization

### Cache Key Strategy
- Use meaningful, stable cache keys
- Avoid changing keys on every render (causes infinite loops)

### Stale Time Configuration
- Realtime data: no stale time (default)
- Dashboard data: 5 minutes
- Static config: 1 hour

### Auto-Limit Behavior
- Default: auto-limit to 1000 rows
- Disable with `autoLimit: false` for intentional large queries

## Error Handling & State Management

### Complete State Handling
Always handle `isLoading`, `error`, and empty data states. See [extended examples](../../docs/analytics/warehouse-query-hooks.md#error-handling).

## Type Safety

### Generic Type Usage
- **MUST** specify generic types: `useWarehouseQuery<ProjectRow>(...)`
- TypeScript provides full type safety for query results

## Rules

- **MUST** use parameterized queries (never string interpolation)
- **MUST** specify generic types for query results
- **MUST** handle loading, error, and empty states
- **MUST** use stable cache keys
- **MUST** use appropriate `staleTime` for data freshness
- **SHOULD** use `useWarehouseQueryCached` for complex caching scenarios

## Advanced Patterns

For optimistic updates, factory patterns, conditional queries, and migration guides, see [extended documentation](../../docs/analytics/warehouse-query-hooks.md#advanced-patterns).

## Common Pitfalls

For detailed examples of infinite loops, memory leaks, and race conditions, see [extended documentation](../../docs/analytics/warehouse-query-hooks.md#troubleshooting).

## Enforcement

### ESLint Rules (Planned)
The following ESLint rules are planned for future implementation:
- `@corso/warehouse-query-type-safety`: Enforce type parameters
- `@corso/warehouse-query-error-handling`: Enforce error handling
- `@corso/warehouse-query-sql-injection`: Prevent SQL injection

**Note**: These rules are not yet implemented in `eslint-plugin-corso`. Enforcement is currently handled via TypeScript types and code review.

For AST-Grep rules and ESLint configuration, see [extended documentation](../../docs/analytics/warehouse-query-hooks.md#enforcement).

## Windows-first tips

See the canonical guidance in
[ai-agent-development-environment.mdc](mdc:.cursor/rules/ai-agent-development-environment.mdc#windows-first-tips).

## Related Rules

- `cursor/security-standards` - SQL injection prevention
- `cursor/runtime-boundaries` - Server/Edge import safety
- `cursor/code-quality-standards` - TypeScript standards
