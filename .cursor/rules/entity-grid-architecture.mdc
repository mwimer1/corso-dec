---
rule_id: entity-grid-architecture
title: Entity Grid Architecture (AG Grid)
owners: ["@web"]
status: active
domains: ["ui"]
enforcement: advise
alwaysApply: true
globs:
  - "components/dashboard/entities/**"
  - "lib/vendors/ag-grid/**"
related_rules:
  - dashboard-components
  - component-design-system
last_reviewed: "2025-01-29"
summary: Standardize AG Grid setup, registration, SSRM usage, and boundaries.
---

## Purpose
Define the standardized, flattened AG Grid architecture for dashboard entities (projects, addresses, companies): generic `EntityGrid`, per-entity `config.ts`, and a typed `registry` consumed by the `[entity]` route with Zod validation.

## TL;DR
- **Phase 3B Complete**: Legacy `col-defs.ts` files removed, full TableColumnConfig adoption
- Framework-agnostic columns: `lib/entities/<entity>/columns.config.ts` with TableColumnConfig schema
- Shared grid: `components/dashboard/entities/shared/grid/{EntityGrid.tsx, types.ts, ag-grid-modules.ts, fetchers.ts}`
- Per-entity config: `components/dashboard/entities/<entity>/config.ts` wires async `colDefs` provider + fetcher
- Typed registry and barrel: `components/dashboard/entities/index.ts` exports `getEntityConfig`, `EntityGrid`, types
- Route: `[entity]/page.tsx` validates with Zod and renders via registry
- Client-safe fetchers: `createEntityFetcher(entity)` GETs from `/api/v1/entity/{entity}` with query params
- Mock mode: set `CORSO_USE_MOCK_DB=true` to serve mock JSON via `getEntityPage()`

## File Layout
```
components/dashboard/entities/
  shared/
    grid/
      EntityGrid.tsx
      EntityGridHost.tsx
      ag-grid-modules.ts
      fetchers.ts
      types.ts
    renderers/     # Minimal formatters/constants only
      value-formatter.ts
      constants.ts
      helpers.tsx  # FaviconRenderer
  projects/
    config.ts      # Uses PROJECTS_COLUMNS from lib/entities
    index.ts
  addresses/
    config.ts      # Uses ADDRESSES_COLUMNS from lib/entities
    index.ts
  companies/
    config.ts      # Uses COMPANIES_COLUMNS from lib/entities
    index.ts
  index.ts         # EntityGrid exports + registry + getEntityConfig

# Column definitions now live in:
lib/entities/
  projects/columns.config.ts    # TableColumnConfig definitions
  companies/columns.config.ts   # TableColumnConfig definitions
  addresses/columns.config.ts   # TableColumnConfig definitions
  adapters/aggrid.ts            # toColDef() adapter for AG Grid mapping
```

## Route Integration
- Validator: `lib/validators/entity.ts`
- Route: `app/(protected)/dashboard/(entities)/[entity]/page.tsx`
- Pattern:
  - Validate `params` → `EntityParamSchema`.
  - Use `getEntityConfig(entity)` to retrieve `EntityGridConfig`.
  - Render via `EntityGridHost` (client) or integrate into existing page chrome.

## Fetchers
- Use `createEntityFetcher('projects'|'addresses'|'companies')`.
- Maps AG Grid server-side request to:
  ```json
  { "page": { "index": 0, "size": 50 }, "sort": [{ "field": "colId", "dir": "asc" }] }
  ```
- POST to `/api/v1/entity/{entity}/query` (edge-safe at callsite).

## AG Grid Module Registration

**Critical**: AG Grid modules must be registered before any grid is instantiated. The grid uses `rowModelType="serverSide"` which requires Enterprise modules.

### Registration Pattern
- **Client-only registration**: `lib/vendors/ag-grid.client.ts` registers `AllEnterpriseModule`
- **Component integration**: `EntityGrid` component calls `ensureAgGridReadyFor()` in a `useEffect` hook
- **Timing**: Registration happens client-side after component mount when environment variables are available

### Environment Requirements
- `NEXT_PUBLIC_AGGRID_ENTERPRISE=1` must be set (required for server-side row model)
- `NEXT_PUBLIC_AGGRID_LICENSE_KEY` (optional, removes watermark in production; legacy `NEXT_PUBLIC_AG_GRID_LICENSE_KEY` also supported)

### Implementation Details
Registration happens in `useEffect` hook (client-side, after mount). `EntityGrid` calls `ensureAgGridReadyFor("serverSide")`, which calls `ensureAgGridRegistered()` from `lib/vendors/ag-grid.client.ts`, which registers `AllEnterpriseModule` (includes `ServerSideRowModelModule`).

## Implementation Details

### SSRM Callback Pattern
The grid uses AG Grid's expected SSRM callback pattern with `p.success()` and `p.fail()`.

### Credentials Configuration
Fetchers use `credentials: 'include'` to send cookies with same-origin requests.

### Schema Mapping
Column definitions use framework-agnostic `TableColumnConfig` schema that adapts to AG Grid `ColDef` via `lib/entities/adapters/aggrid.ts` (`toColDef()`).

### RBAC Enforcement
API routes enforce organization-scoped RBAC: authentication required (Clerk `userId`), organization context required (`orgId`), role check `has({ role: 'org:member' })` (org:member or higher).

## Known Limitations

### Filtering
- **Limited filter operations**: Only `eq`, `contains`, `gt`, `lt`, `gte`, `lte`, `in`, `between`, `bool` supported
- **No client-side filtering**: All filters applied server-side via API
- **No filter persistence**: Filters reset on page refresh (saved views can preserve state)
- **Text filters**: Only `contains` and `equals` supported (no `startsWith`/`endsWith`)

### Sorting
- **Single-column sorting**: Only first sort in `sortModel` array is applied by API
- **No multi-column sorting**: AG Grid UI allows multi-column but API uses only first sort

### Type Safety
- **`as any` usage**: Some AG Grid prop types require `as any` casts due to strict TypeScript types:
  - `statusBar`, `sideBar`, `paginationPageSizeSelector`, `rowSelection`, `selectionColumnDef`
  - `onStateUpdated`, `noRowsOverlayComponent`
- **Runtime validation**: API responses validated at runtime, not compile-time

### Performance
- **Server-side pagination required**: Large datasets require proper pagination (no client-side virtualization for full dataset)
- **Bundle size**: AG Grid Enterprise adds significant bundle weight (~500KB+ gzipped)

## Rules
- Do not deep-import renderers; import directly from `shared/renderers/` (no barrel after cleanup).
- Keep server-only code out of `@/components/**` (client bundles).
- Column definitions must use `TableColumnConfig` schema in `lib/entities/<entity>/columns.config.ts`.
- Route options: export top-level literals (`runtime`, `dynamic`, `revalidate`). No `as const`.
- **AG Grid registration**: Never call `ModuleRegistry.registerModules()` directly in components. Use `ensureAgGridRegistered()` from `@/lib/vendors/ag-grid.client`.

## Quality gates

See the canonical command set in
[ai-agent-development-environment.mdc](mdc:.cursor/rules/ai-agent-development-environment.mdc#quality-gates-and-validation-commands).

## Migration Status
✅ **Phase 3B Complete** - Full TableColumnConfig adoption, legacy cleanup finished

**Completed Tasks:**
- ✅ **Phase 1**: Documentation & Architecture (completed)
- ✅ **Phase 2**: Gradual Migration Infrastructure (completed)
- ✅ **Phase 3A**: Component migration to TableColumnConfig system (completed)
- ✅ **Phase 3B**: Full Migration & Cleanup (completed)
  - ✅ Removed deprecated `col-defs.ts` files (3 entities)
  - ✅ Removed unused legacy cell renderers (StatusCellRenderer, etc.)
  - ✅ Removed unused value-getters, status-constants, property-type-constants
  - ✅ Updated all documentation and cursor rules
  - ✅ Bundle size optimization (~5KB reduction)

**Framework Independence Achieved:**
- ✅ Zero legacy code remnants
- ✅ TableColumnConfig exclusive architecture
- ✅ Lazy loading formatters
- ✅ Type-safe column definitions
- ✅ Clean separation between UI and service layers

## Future Enhancements

For future enhancements backlog (Phases 4-6), implementation priority guidelines, and detailed implementation notes, see [extended documentation](../../docs/ai/rules/entity-grid-architecture.md).

