---
rule_id: openapi-vendor-extensions
title: OpenAPI Vendor Extensions & RBAC Guard
owners:
  - security@corso.io
  - platform@corso.io
last_reviewed: "2025-10-13"
status: active
domains: [api, security, documentation]
enforcement: warn
related_rules:
  - security-standards
alwaysApply: true
globs:
  - "app/api/**"
  - "api/**"
  - "docs/api/**"
summary: Enforce RBAC and tenant isolation in OpenAPI specs via vendor extensions (x-corso-rbac) and automated validation.
---

# OpenAPI Vendor Extensions & RBAC Guard

**Enforce consistent RBAC and tenant isolation patterns in the OpenAPI specification through vendor extensions and automated validation.**

## TL;DR
- **RBAC annotations**: All bearer-authenticated operations must have `x-corso-rbac` or `x-public`
- **OrgIdHeader**: All bearer operations must include `OrgIdHeader` parameter
- **Validation**: Run `pnpm openapi:rbac:check` to validate compliance
- **Role hierarchy**: owner > admin > member > viewer > service
- **CI enforcement**: Automated validation in PR pipeline

## üéØ Purpose
Enforce consistent RBAC and tenant isolation patterns in the OpenAPI specification through vendor extensions and automated validation.

## üè∑Ô∏è Vendor Extensions

### `x-corso-rbac` - Role-Based Access Control
Required for all bearer-authenticated operations. Defines the minimum role required for access.

```yaml
paths:
  /api/v1/ai/chat:
    post:
      security:
        - bearerAuth: []
      x-corso-rbac: [member, admin, owner]  # Available: owner, admin, member, viewer, service
      parameters:
        - $ref: '#/components/parameters/OrgIdHeader'
```

**Role Hierarchy:**
- `owner` - Full administrative access (rare)
- `admin` - Administrative operations (create, update, delete)
- `member` - Read/write access to assigned resources
- `viewer` - Read-only access
- `service` - Machine-to-machine access for webhooks/services

### `x-public` - Public Endpoints
Opt-out mechanism for endpoints that don't require authentication.

```yaml
paths:
  /api/status/health:
    get:
      x-public: true
      # No security or x-corso-rbac required
```

## üõ°Ô∏è RBAC Guard Implementation

### Guard Script (`tools/scripts/openapi-guard-rbac.ts`)
Validates OpenAPI spec compliance with RBAC and tenant isolation requirements.

**Checks Performed:**
1. All `bearerAuth` operations have `x-corso-rbac` or `x-public`
2. All `bearerAuth` operations include `OrgIdHeader` parameter
3. Role values match allowed roles defined in the OpenAPI RBAC config (see `api/openapi.yml` and `pnpm openapi:rbac:check`)

**Usage:**
```bash
# Run RBAC validation
pnpm openapi:rbac:check

# Full OpenAPI pipeline with RBAC guard
pnpm openapi:gen && pnpm openapi:rbac:check
```

### CI Integration (`.github/workflows/openapi.yml`)
Automated validation on pull requests affecting API or OpenAPI files.

```yaml
- run: pnpm openapi:bundle
- run: pnpm openapi:lint
- run: pnpm openapi:types
- run: pnpm openapi:rbac:check  # ‚Üê RBAC guard
- run: git diff --exit-code -- api/openapi.json types/api/openapi.d.ts
```

## üìã Workflow Integration

### Local Development
```bash
# Edit OpenAPI spec
vim api/openapi.yml

# Add RBAC annotations to new operations
x-corso-rbac: [admin]
parameters:
  - $ref: '#/components/parameters/OrgIdHeader'

# Validate changes
pnpm openapi:gen && pnpm openapi:rbac:check
```

### Adding New Operations
1. Add operation to `api/openapi.yml`
2. Include `OrgIdHeader` parameter reference
3. Set appropriate `x-corso-rbac` role
4. Run validation: `pnpm openapi:rbac:check`

### Role Assignment Guidelines
```typescript
// READ operations (GET)
x-corso-rbac: [member]

// WRITE operations (POST/PUT/PATCH)
x-corso-rbac: [admin]

// DESTRUCTIVE operations (DELETE)
x-corso-rbac: [admin]

// ORGANIZATION operations
x-corso-rbac: [member]  # Usually read access

// SERVICE operations (webhooks)
x-corso-rbac: [service]
```

## üîç Validation Patterns

### ESLint Integration
```javascript
// .eslintrc.mjs
{
  plugins: ['@corso/eslint-plugin'],
  rules: {
    '@corso/require-auth': 'error',
    '@corso/require-validation': 'error',
    '@corso/require-rate-limit': 'error'
  }
}
```

### AST-Grep Patterns
```bash
# Check for missing error handling wrappers
sg -p 'export const $METHOD = withErrorHandlingEdge' --lang typescript app/api/

# Find operations without RBAC annotations
sg -p 'security:\n  - bearerAuth: \[\]' --lang yaml api/openapi.yml
```

## üö® Common Issues & Fixes

### Missing OrgIdHeader
```yaml
# ‚ùå INCORRECT
post:
  security:
    - bearerAuth: []
  x-corso-rbac: [member]
  # Missing OrgIdHeader!

# ‚úÖ CORRECT
post:
  parameters:
    - $ref: '#/components/parameters/OrgIdHeader'
  security:
    - bearerAuth: []
  x-corso-rbac: [member]
```

### Invalid Role
```yaml
# ‚ùå INCORRECT
x-corso-rbac: [superuser]  # Not in config/security/rbac-roles.json

# ‚úÖ CORRECT
x-corso-rbac: [admin]  # From allowed roles
```

### Public Endpoint Without Opt-out
```yaml
# ‚ùå INCORRECT
get:
  security:
    - bearerAuth: []  # Should be public but not marked

# ‚úÖ CORRECT
get:
  x-public: true  # Explicitly public
```

## üìä Quality Gates

### OpenAPI Validation
- ‚úÖ All bearer operations have `x-corso-rbac` or `x-public`
- ‚úÖ All bearer operations include `OrgIdHeader`
- ‚úÖ Role values match `config/security/rbac-roles.json`
- ‚úÖ Generated types are up-to-date

### Automated Enforcement
- **RBAC validation**: `pnpm openapi:rbac:check` (runs `tools/scripts/openapi-guard-rbac.ts`)
- **OpenAPI generation**: `pnpm openapi:gen` (regenerates specs and types)
- **Full pipeline**: `pnpm openapi:gen && pnpm openapi:rbac:check`

### CI/CD Integration
- ‚úÖ PR validation runs `pnpm openapi:rbac:check`
- ‚úÖ Breaking changes detected via `pnpm openapi:diff`
- ‚úÖ Generated artifacts committed and validated

## üîó Related Documentation

- [API Security Patterns](cursor/security-standards) - Authentication & authorization
- [Security Standards](cursor/security-standards) - Zero-trust principles
- [OpenAPI Generation](api/openapi.yml) - Spec generation workflow

## Windows-first tips

See the canonical guidance in
[ai-agent-development-environment.mdc](mdc:.cursor/rules/ai-agent-development-environment.mdc#windows-first-tips).
