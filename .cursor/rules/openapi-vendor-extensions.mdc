---
rule_id: openapi-vendor-extensions
title: OpenAPI Vendor Extensions & RBAC Guard
owners:
  - security@corso.io
  - platform@corso.io
last_reviewed: "2026-01-15"
status: active
domains: [api, security, documentation]
enforcement: warn
related_rules:
  - security-standards
alwaysApply: true
globs:
  - "app/api/**"
  - "api/**"
  - "docs/api/**"
summary: Enforce RBAC and tenant isolation in OpenAPI specs via vendor extensions (x-corso-rbac) and automated validation.
---

# OpenAPI Vendor Extensions & RBAC Guard

**Enforce consistent RBAC and tenant isolation patterns in the OpenAPI specification through vendor extensions and automated validation.**

## TL;DR
- **RBAC annotations**: All bearer-authenticated operations must have `x-corso-rbac` or `x-public`
- **OrgIdHeader**: Personal-scope routes use `OrgIdHeaderOptional`; non-personal-scope routes use `OrgIdHeader` (required)
- **Validation**: Run `pnpm openapi:rbac:check` to validate compliance
- **Role hierarchy**: owner > admin > member > viewer > service
- **CI enforcement**: Automated validation in PR pipeline

## üéØ Purpose
Enforce consistent RBAC and tenant isolation patterns in the OpenAPI specification through vendor extensions and automated validation.

## üè∑Ô∏è Vendor Extensions

### `x-corso-rbac` - Role-Based Access Control
Required for all bearer-authenticated operations. Defines the minimum role required for access.

```yaml
paths:
  /api/v1/ai/chat:
    post:
      security:
        - bearerAuth: []
      x-corso-rbac: [member, admin, owner]  # Available: owner, admin, member, viewer, service
      x-corso-personal-scope: true  # Supports both org-scoped and user-scoped access
      parameters:
        - $ref: '#/components/parameters/OrgIdHeaderOptional'  # Optional for personal-scope routes
```

**Role Hierarchy:**
- `owner` - Full administrative access (rare)
- `admin` - Administrative operations (create, update, delete)
- `member` - Read/write access to assigned resources
- `viewer` - Read-only access
- `service` - Machine-to-machine access for webhooks/services

### `x-public` - Public Endpoints
Opt-out mechanism for endpoints that don't require authentication.

```yaml
paths:
  /api/status/health:
    get:
      x-public: true
      # No security or x-corso-rbac required
```

## üõ°Ô∏è RBAC Guard Implementation

### Guard Script (`tools/scripts/openapi-guard-rbac.ts`)
Validates OpenAPI spec compliance with RBAC and tenant isolation requirements.

**Checks Performed:**
1. All `bearerAuth` operations have `x-corso-rbac` or `x-public`
2. All `bearerAuth` operations include organization header parameter:
   - Personal-scope routes (`x-corso-personal-scope: true`) ‚Üí `OrgIdHeaderOptional`
   - Non-personal-scope routes ‚Üí `OrgIdHeader` (required)
3. Role values match allowed roles defined in the OpenAPI RBAC config (see `api/openapi.yml` and `pnpm openapi:rbac:check`)

**Usage:**
```bash
# Run RBAC validation
pnpm openapi:rbac:check

# Full OpenAPI pipeline with RBAC guard
pnpm openapi:gen && pnpm openapi:rbac:check
```

### CI Integration (`.github/workflows/openapi.yml`)
Automated validation on pull requests affecting API or OpenAPI files.

```yaml
- run: pnpm openapi:bundle
- run: pnpm openapi:lint
- run: pnpm openapi:types
- run: pnpm openapi:rbac:check  # ‚Üê RBAC guard
- run: git diff --exit-code -- api/openapi.json types/api/generated/openapi.d.ts
```

## Rules

- **MUST** include `x-corso-rbac` or `x-public` for all bearer-authenticated operations
- **MUST** include organization header parameter for all bearer operations:
  - Personal-scope routes (`x-corso-personal-scope: true`) ‚Üí `OrgIdHeaderOptional`
  - Non-personal-scope routes ‚Üí `OrgIdHeader` (required, currently unused - all routes are personal-scope)
- **MUST** use valid roles from allowed roles (owner, admin, member, viewer, service)
- **MUST** run `pnpm openapi:rbac:check` to validate compliance

## Workflow Integration

For local development workflow, adding new operations, role assignment guidelines, and CI/CD integration, see [extended documentation](../../docs/ai/rules/openapi-vendor-extensions.md#workflow-integration-details).

## Common Issues & Fixes

For missing OrgIdHeader, invalid roles, and public endpoint patterns, see [extended documentation](../../docs/ai/rules/openapi-vendor-extensions.md#common-issues--fixes).

## Quality Gates

### OpenAPI Validation
- ‚úÖ All bearer operations have `x-corso-rbac` or `x-public`
- ‚úÖ All bearer operations include organization header (`OrgIdHeaderOptional` for personal-scope, `OrgIdHeader` for non-personal-scope)
- ‚úÖ Role values match `config/security/rbac-roles.json`
- ‚úÖ Generated types are up-to-date

### Automated Enforcement
- **RBAC validation**: `pnpm openapi:rbac:check` (runs `tools/scripts/openapi-guard-rbac.ts`)
- **OpenAPI generation**: `pnpm openapi:gen` (regenerates specs and types)
- **Full pipeline**: `pnpm openapi:gen && pnpm openapi:rbac:check`

## üîó Related Documentation

- [API Security Patterns](cursor/security-standards) - Authentication & authorization
- [Security Standards](cursor/security-standards) - Zero-trust principles
- [OpenAPI Generation](api/openapi.yml) - Spec generation workflow

## Windows-first tips

See the canonical guidance in
[ai-agent-development-environment.mdc](mdc:.cursor/rules/ai-agent-development-environment.mdc#windows-first-tips).
