---
rule_id: security-standards
title: Security Standards & API Patterns (Consolidated)
owners:
  - security@corso.io
  - platform@corso.io
last_reviewed: "2025-12-15"
status: active
domains: [security, api]
enforcement: block
related_rules:
  - openapi-vendor-extensions
  - runtime-boundaries
alwaysApply: true
globs: ["app/api/**", "actions/**", "lib/api/**", "lib/middleware/**"]
summary: Zero-trust security with Clerk auth, Zod validation, rate limiting, and error handling for all API routes.
# Reviewed in Dec 2025 - Current security practices verified, no deprecated patterns found
---

# üîê Security Standards & API Patterns (Consolidated)

**Comprehensive security guide covering authentication, authorization, validation, rate limiting, and error handling for all Corso applications.**

## TL;DR
- **Zero-trust**: Authenticate, authorize, validate, rate-limit, and log everything
- **Clerk auth**: Use `auth()` from `@clerk/nextjs/server` for all protected routes
- **Zod validation**: Validate all inputs with schemas before processing
- **Error handling**: Prefer `makeEdgeRoute` to compose Zod validation + error handling; use `http.*` helpers inside handlers
- **Rate limiting**: Apply via `makeEdgeRoute({ rateLimit })` or `withRateLimitEdge`
- **Environment**: Use `getEnv()` exclusively, never `process.env` directly
- **SQL safety**: Always validate AI-generated SQL with tenant scoping

## Purpose
Enforce zero-trust security architecture with authentication, authorization, validation, rate limiting, and error handling for all API routes and server actions.

## Core Security Principles

### Zero-Trust Architecture
See canonical snippet: [_snippets.mdc#zero-trust-security-principles](_snippets.mdc#zero-trust-security-principles)

**Key Principles:**
- **Authenticate** all requests to protected resources
- **Authorize** based on user identity and role-based access control (RBAC)
- **Validate** all inputs using strict schemas
- **Rate limit** all endpoints to prevent abuse
- **Log** security events for monitoring and auditing

## Authentication & Authorization

### Clerk Integration (Required)
Use `auth()` from `@clerk/nextjs/server` for all protected routes. See [extended examples](../../docs/ai/rules/security-standards.md#clerk-authentication---complete-example).

### Role-Based Access Control
Use `assertRole()` for permission checks. See [extended examples](../../docs/ai/rules/security-standards.md#role-based-access-control---complete-example).

## Rate Limiting & Abuse Prevention

### Edge Runtime Rate Limiting
Apply via `makeEdgeRoute({ rateLimit })` or `withRateLimitEdge`. Standard config: `{ maxRequests: 30, windowMs: 60_000 }`.

### Exemptions
- `/api/status/health` ‚Äî Do NOT apply app-level rate limits. Health checks must remain unthrottled for load balancers/monitors.

## Input Validation & Sanitization

### Zod Schema Validation (Required)
See canonical snippet: [_snippets.mdc#zod-request-validation-pattern](_snippets.mdc#zod-request-validation-pattern)

### SQL Injection Prevention
Always use parameterized queries. Validate AI-generated SQL with `validateAISQLSecurity()`.

### AI Prompt Injection Prevention
Use `sanitizeUserInput()` for all AI endpoints (`/api/v1/ai/chat`, `/api/v1/ai/generate-sql`).

## Webhook Security

### Stripe & Clerk Webhook Verification
Always verify webhook signatures. See [extended examples](../../docs/ai/rules/security-standards.md#webhook-security---detailed-patterns).

## Error Handling

### Structured Error Responses
See canonical snippet: [_snippets.mdc#error-handling-wrapper--http-helpers](_snippets.mdc#error-handling-wrapper--http-helpers)

## Environment & Configuration

### Environment Variable Access
- ‚úÖ Use `getEnv()` from `@/lib/server/env` (server-only)
- ‚úÖ Use `publicEnv` from `@/lib/shared/config/client` (client components)
- ‚ùå Never use `process.env` directly

### Runtime Selection
- Edge Runtime: `export const runtime = "edge"` (low-latency operations)
- Node.js Runtime: `export const runtime = "nodejs"` (database operations)

## Rules

- **MUST** authenticate all protected routes with Clerk `auth()`
- **MUST** validate all inputs with Zod schemas
- **MUST** apply rate limiting to all applicable endpoints
- **MUST** use `getEnv()` for environment access (never `process.env`)
- **MUST** verify webhook signatures (Stripe, Clerk)
- **MUST** sanitize AI user input with `sanitizeUserInput()`
- **MUST** use `makeEdgeRoute` or `withErrorHandlingEdge` for error handling
- **MUST** maintain Edge compatibility in `@/lib/api` barrel
- **MUST** maintain client compatibility in `@/lib/shared` barrel

## API Surface Enforcement
- Public endpoints must be versioned under `/api/v1/**`
- Internal/privileged endpoints must live under `/api/internal/**` and are excluded from OpenAPI
- Legacy unversioned endpoints should be removed or provide a one‚Äërelease 308 redirect to the v1 path

## @/lib/api Edge Safety (Critical)
The `@/lib/api` barrel **must remain Edge-compatible** at all times:
- ‚úÖ Exports only Edge-safe utilities (http helpers, redirect helpers, withErrorHandlingEdge)
- ‚ùå Never re-exports Node-only utilities (ClickHouse, server-side rate limiting, streaming)
- ‚úÖ Use subpath imports for server utilities: `@/lib/server/streaming/ndjson` instead of `@/lib/server`

**Breaking this rule will cause all Edge routes to fail at runtime.**

## @/lib/shared Client Safety (Critical)
The `@/lib/shared` barrel **must remain client-compatible** at all times:
- ‚úÖ Exports only client-safe utilities (validation schemas, config helpers, assets)
- ‚ùå Never re-exports server-only utilities (environment validation, domain configs, feature flags)
- ‚úÖ Use `@/lib/shared/client` for client components and `@/lib/shared/server` for server-only code

**Breaking this rule will cause all client components to fail at runtime.**

## Enforcement

### ESLint Rules
- `@corso/require-auth`: Enforce authentication on protected routes
- `@corso/require-validation`: Enforce input validation
- `@corso/require-rate-limit`: Enforce rate limiting

### Enforcement Criteria
- **Authentication Coverage**: 100% for protected routes
- **Rate Limiting Coverage**: 100% for applicable routes
- **Input Validation**: 100% with Zod schemas
- **Error Handling**: 100% with `withErrorHandlingEdge`
- **Security Logging**: 100% for security events

### Automated Enforcement
- **ast-grep patterns**: `withErrorHandlingEdge`, `withRateLimitEdge` (enforced via `ast-grep run`)
- **CI validation**: `pnpm validate:cursor-rules` runs rule compliance checks
- **OpenAPI RBAC**: `pnpm openapi:rbac:check` validates security annotations

## Quality gates

See the canonical command set in
[ai-agent-development-environment.mdc](mdc:.cursor/rules/ai-agent-development-environment.mdc#quality-gates-and-validation-commands).

## Extended Documentation

For extended code examples, webhook verification patterns, monitoring examples, and Clerk UI contract details, see [docs/ai/rules/security-standards.md](../../docs/ai/rules/security-standards.md).

## Windows-first tips

See the canonical guidance in
[ai-agent-development-environment.mdc](mdc:.cursor/rules/ai-agent-development-environment.mdc#windows-first-tips).

## Related Rules

- `cursor/openapi-vendor-extensions` - OpenAPI RBAC enforcement
- `cursor/runtime-boundaries` - Server/Edge import safety
