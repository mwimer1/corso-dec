# .github/workflows/pr-checks.yml
name: PR Checks

on:
  pull_request:
    branches: [main]
    paths:
      - "app/**"
      - "components/**"
      - "hooks/**"
      - "lib/**"
      - "tests/**"
      - "styles/**"
      - "public/**"
      - "docs/**"
      - "README.md"
      - "CHANGELOG.md"
      - "package.json"
      - "pnpm-lock.yaml"
      - "next.config.mjs"
      - "tailwind.config.ts"
      - ".markdownlint.jsonc"
      - "jscpd.docs.json"
      - "config/.cspell.json"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  setup:
    name: Setup & Build
    uses: ./.github/workflows/_reusable-node-job.yml
    permissions:
      contents: read
    with:
      name: setup
      fetch_depth: 0
      install: true
      run: pnpm build
      upload_artifact: true
      artifact_name: build-output-${{ github.sha }}
      artifact_path: .next/
    secrets: inherit

  markdown-lint:
    name: Markdown Lint
    uses: ./.github/workflows/_reusable-node-job.yml
    permissions:
      contents: read
    with:
      name: markdown-lint
      fetch_depth: 0
      install: true
      run: pnpm lint:md
    secrets: inherit

  link-check:
    name: Link Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Check links in docs
        uses: lycheeverse/lychee-action@v1
        with:
          files: docs/**/*.md README.md CHANGELOG.md
          ignore: "http://localhost:*,http://127.0.0.1:*"
          retry: 2
          args: "--verbose"

  docs-duplication-check:
    name: Docs Duplication Check
    uses: ./.github/workflows/_reusable-node-job.yml
    permissions:
      contents: read
    with:
      name: docs-duplication-check
      fetch_depth: 0
      install: true
      run: pnpm jscpd:docs
    secrets: inherit

  docs-spellcheck:
    name: Docs Spellcheck
    uses: ./.github/workflows/_reusable-node-job.yml
    permissions:
      contents: read
    with:
      name: docs-spellcheck
      fetch_depth: 0
      install: true
      run: pnpm docs:spellcheck || true
    continue-on-error: true
    secrets: inherit

  docs-sync-check:
    name: Docs Sync Check
    uses: ./.github/workflows/_reusable-node-job.yml
    permissions:
      contents: read
    with:
      name: docs-sync-check
      fetch_depth: 0
      install: true
      run: pnpm docs:check:sync
    secrets: inherit

  lighthouse:
    name: Performance Audit
    needs: setup
    uses: ./.github/workflows/_reusable-node-job.yml
    with:
      name: lighthouse
      fetch_depth: 0
      install: true
      run: |
        pnpm dlx @lhci/cli@0.14.0 autorun \
          --collect.startServerCommand="pnpm start" \
          --collect.url=http://localhost:3000/ \
          --upload.target=temporary-public-storage

  bundle-size:
    name: Bundle Size Analysis
    needs: setup
    uses: ./.github/workflows/_reusable-node-job.yml
    with:
      name: bundle-size
      fetch_depth: 0
      install: true
      run: |
        # Analyze current bundle size (on PR branch)
        PR_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        pnpm bundlesize:ci > bundle-size-current.json

        # Get base branch bundle size
        git checkout origin/main
        pnpm install --frozen-lockfile
        pnpm build
        pnpm bundlesize:ci > bundle-size-base.json || echo '{"totalGzippedSize": 0}' > bundle-size-base.json

        # Checkout back to PR branch to generate report (untracked JSON files persist across checkouts)
        git checkout $PR_BRANCH

        # Generate report (both JSON files available as untracked files)
        pnpm -s bundlesize:report \
          --current=bundle-size-current.json \
          --base=bundle-size-base.json \
          --output=bundle-report.md

        # Set output for PR comment
        {
          echo "report<<EOF"
          cat bundle-report.md
          echo "EOF"
        } >> $GITHUB_OUTPUT

  bundle-comment:
    name: Bundle Size Comment
    needs: bundle-size
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('bundle-report.md', 'utf8');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });

  css-size:
    name: CSS Size Check
    needs: setup
    uses: ./.github/workflows/_reusable-node-job.yml
    with:
      name: css-size
      fetch_depth: 0
      install: true
      run: pnpm a11y:css-size
    secrets: inherit

  duplication-check:
    name: Tests Duplication Guard
    needs: setup
    if: ${{ github.event_name == 'pull_request' }}
    uses: ./.github/workflows/_reusable-node-job.yml
    with:
      name: duplication-check
      fetch_depth: 0
      install: true
      run: pnpm dup:tests:ci

