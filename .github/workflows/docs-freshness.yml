name: Documentation Freshness Check

on:
  schedule:
    - cron: '0 0 1 * *'  # 1st of each month at midnight UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-freshness:
    name: Check Documentation Freshness
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node & pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          run-install: 'true'

      - name: Check for stale documentation
        id: stale-check
        run: |
          pnpm docs:stale:check --maxAgeDays=90 || true
        continue-on-error: true

      - name: Create issue for stale docs
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            try {
              // Run the stale check and capture output
              const output = execSync('pnpm docs:stale:check --maxAgeDays=90', {
                encoding: 'utf8',
                stdio: ['pipe', 'pipe', 'pipe']
              });
            } catch (error) {
              // Capture stderr which contains the stale file list
              const staleFiles = error.stderr || error.stdout || 'Unable to determine stale files';
              
              const issueTitle = `ðŸ“š Documentation Freshness Check - Stale Files Found`;
              const issueBody = `## Documentation Freshness Check Failed
              
              The monthly documentation freshness check found files that haven't been updated in over 90 days.
              
              Please review and update the following files:
              
              \`\`\`
              ${staleFiles}
              \`\`\`
              
              ### Next Steps
              1. Review each file to determine if content needs updating
              2. Update the \`Last updated: YYYY-MM-DD\` line if the content is still accurate
              3. Update both the content and date if changes are needed
              4. If a file is intentionally stable, consider documenting this in the file
              
              ### How to Update
              Run the following command to update dates:
              \`\`\`bash
              pnpm docs:fresh
              \`\`\`
              
              Or manually edit files to update the \`Last updated:\` line.
              
              ---
              
              *This issue was automatically created by the Documentation Freshness Check workflow.*`;
              
              // Check if an issue with the same title already exists
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'documentation,freshness',
              });
              
              const existingIssue = issues.find(issue => issue.title === issueTitle);
              
              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['documentation', 'freshness', 'automated'],
                });
                console.log('Created new issue for stale documentation');
              } else {
                console.log('Issue already exists for stale documentation, skipping creation');
              }
            }
