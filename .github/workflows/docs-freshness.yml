name: Documentation Freshness Check

on:
  schedule:
    # Run on the 1st of each month at midnight UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-freshness:
    name: Check Documentation Freshness
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node & pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          run-install: true

      - name: Check documentation freshness
        id: freshness-check
        continue-on-error: true
        run: |
          # Capture output to variable
          STALE_OUTPUT=$(pnpm docs:stale:check --maxAgeDays=90 2>&1 || true)
          echo "stale_output<<EOF" >> $GITHUB_OUTPUT
          echo "$STALE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check exit code
          pnpm docs:stale:check --maxAgeDays=90 || echo "has_stale=true" >> $GITHUB_OUTPUT

      - name: Create issue for stale documentation
        if: steps.freshness-check.outputs.has_stale == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const staleOutput = `${{ steps.freshness-check.outputs.stale_output }}`;
            const staleFiles = staleOutput
              .split('\n')
              .filter(line => line.includes('stale'))
              .map(line => line.replace(/^.*stale[^(]*\(/, '').replace(/\):.*$/, ''))
              .filter(Boolean);
            
            if (staleFiles.length === 0) {
              console.log('No stale files found in output');
              return;
            }
            
            const issueBody = `# Documentation Freshness Alert
            
The following documentation files are older than 90 days and may need review:
            
${staleFiles.map(file => `- \`${file}\``).join('\n')}
            
Please review these files and update them if needed. You can update the "Last updated:" date by running:
            
\`\`\`bash
pnpm docs:fresh
\`\`\`
            
Or manually update the date in each file.
            
---
            
_This issue was automatically created by the documentation freshness check workflow._`;
            
            // Check if an open issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,freshness',
              per_page: 100
            });
            
            const existingIssue = issues.find(issue => 
              issue.title === 'Documentation Freshness Alert' &&
              issue.body && issue.body.includes('Documentation Freshness Alert')
            );
            
            if (existingIssue) {
              console.log(`Updating existing issue #${existingIssue.number}`);
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `This issue was updated by the automated freshness check on ${new Date().toISOString().split('T')[0]}.`
              });
            } else {
              console.log('Creating new issue');
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Documentation Freshness Alert',
                body: issueBody,
                labels: ['documentation', 'freshness']
              });
            }
