name: Security Audit
on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: '0 6 * * 1' # Mondays 06:00 UTC

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  dependency-audit:
    name: Dependency Vulnerability Audit
    uses: ./.github/workflows/_reusable-node-job.yml
    with:
      name: dependency-audit
      fetch_depth: 0
      install: true
      run: |
        echo "## Dependency Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### AI Dependency Audit" >> $GITHUB_STEP_SUMMARY
        pnpm audit:ai >> $GITHUB_STEP_SUMMARY || true
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Standard Dependency Audit" >> $GITHUB_STEP_SUMMARY
        pnpm audit:ci >> $GITHUB_STEP_SUMMARY || true
        
        # Fail on high/critical vulnerabilities
        pnpm audit --audit-level=high

  codeql-analysis:
    name: CodeQL Security Analysis
    permissions:
      contents: read
      security-events: write
      actions: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Setup Node & pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          run-install: 'true'

      - name: Initialize CodeQL
        uses: github/codeql-action/init@ad2a4837011b42f6947b78d6417e7c253b1c504b # v3
        with:
          languages: javascript
          config-file: ./.github/codeql/codeql-config.yml

      - name: Build for CodeQL
        run: pnpm build:offline

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@ad2a4837011b42f6947b78d6417e7c253b1c504b # v3

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node & pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          run-install: 'true'

      - name: Validate Gitleaks Config
        run: pnpm tools:gitleaks:validate

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: config/.gitleaks.toml

  security-summary:
    name: Security Audit Summary
    needs: [dependency-audit, codeql-analysis, secret-scanning]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Security Summary
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dependency audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ CodeQL analysis: ${{ needs.codeql-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Secret scanning: ${{ needs.secret-scanning.result }}" >> $GITHUB_STEP_SUMMARY


